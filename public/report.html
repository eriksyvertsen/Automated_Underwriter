<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report - AI Underwriting Reports</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .report-container {
      max-width: 900px;
      margin: 2rem auto;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      padding: 2rem;
    }
    .report-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #dee2e6;
    }
    .report-meta {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 0.5rem;
    }
    .report-section {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .report-section:last-child {
      border-bottom: none;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .section-actions {
      font-size: 0.9rem;
    }
    #loading-container {
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .report-actions {
      margin-top: 2rem;
      text-align: center;
    }
    .status-badge {
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/dashboard.html">AI Underwriting Reports</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="/dashboard.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#create-report-modal">New Report</a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <span id="user-name">User</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
              <li><a class="dropdown-item" href="#" id="logout-btn">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Loading Container -->
  <div id="loading-container" class="container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading report...</p>
  </div>

  <!-- Report Container (Hidden until loaded) -->
  <div id="report-container" class="report-container" style="display: none;">
    <div class="report-header">
      <h1 id="report-title">Company Name</h1>
      <div class="report-meta">
        <span class="badge" id="report-status">Status</span>
        <span id="report-date">Date</span>
        <span id="report-template">Template</span>
      </div>
    </div>

    <div id="report-content">
      <!-- Report sections will be inserted here -->
    </div>

    <div class="report-actions">
      <button class="btn btn-primary" id="generate-btn">Generate Report</button>
      <button class="btn btn-outline-secondary" id="export-btn">Export PDF</button>
      <a href="/dashboard.html" class="btn btn-link">Back to Dashboard</a>
    </div>
  </div>

  <!-- Empty State (Hidden until needed) -->
  <div id="empty-state" class="container report-container text-center" style="display: none;">
    <div class="py-5">
      <h2>Report Not Found</h2>
      <p class="text-muted">The report you're looking for doesn't exist or you don't have permission to view it.</p>
      <a href="/dashboard.html" class="btn btn-primary mt-3">Back to Dashboard</a>
    </div>
  </div>

  <!-- Report Section Template (Hidden) -->
  <template id="section-template">
    <div class="report-section">
      <div class="section-header">
        <h2 class="section-title">Section Title</h2>
        <div class="section-actions">
          <small class="text-muted section-meta">Generated on: <span class="section-date">Date</span></small>
          <button class="btn btn-sm btn-outline-primary ms-2 regenerate-btn">Regenerate</button>
        </div>
      </div>
      <div class="section-content">
        <!-- Section content will be inserted here -->
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Auth check
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');

      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      // Set user name
      const userNameElement = document.getElementById('user-name');
      if (userNameElement) {
        userNameElement.textContent = user.name || 'User';
      }

      // Logout functionality
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/login.html';
        });
      }

      // Get report ID from URL
      const urlParts = window.location.pathname.split('/');
      const reportId = urlParts[urlParts.indexOf('reports') + 1];

      if (!reportId) {
        // No report ID found in URL
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      // Load report data
      const loadReport = async () => {
        try {
          const response = await fetch(`/api/reports/${reportId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error('Report not found');
          }

          const data = await response.json();
          const report = data.report;

          // Hide loading, show report
          document.getElementById('loading-container').style.display = 'none';
          document.getElementById('report-container').style.display = 'block';

          // Set report data
          document.getElementById('report-title').textContent = report.companyName;
          document.title = `${report.companyName} | AI Underwriting Reports`;

          // Set status badge
          const statusBadge = document.getElementById('report-status');
          let badgeClass = 'bg-secondary';
          let statusText = 'Draft';

          if (report.status === 'generating') {
            badgeClass = 'bg-warning text-dark';
            statusText = 'Generating';
          } else if (report.status === 'completed') {
            badgeClass = 'bg-success';
            statusText = 'Completed';
          } else if (report.status === 'in_progress') {
            badgeClass = 'bg-info text-dark';
            statusText = 'In Progress';
          } else if (report.status === 'failed') {
            badgeClass = 'bg-danger';
            statusText = 'Failed';
          }

          statusBadge.className = `badge ${badgeClass}`;
          statusBadge.textContent = statusText;

          // Set date and template
          const date = new Date(report.updatedAt);
          document.getElementById('report-date').textContent = `Updated: ${date.toLocaleDateString()}`;

          const templateName = report.templateType 
            ? report.templateType.charAt(0).toUpperCase() + report.templateType.slice(1) 
            : 'Standard';
          document.getElementById('report-template').textContent = `Template: ${templateName}`;

          // Render sections
          const reportContent = document.getElementById('report-content');
          reportContent.innerHTML = '';

          if (!report.sections || report.sections.length === 0) {
            reportContent.innerHTML = `
              <div class="text-center py-5">
                <p class="text-muted">No sections have been generated yet.</p>
                <button class="btn btn-primary mt-3" id="generate-empty-btn">
                  Generate Report Content
                </button>
              </div>
            `;

            document.getElementById('generate-empty-btn').addEventListener('click', function() {
              generateReport(reportId, report);
            });
          } else {
            // Render each section
            const template = document.getElementById('section-template');

            report.sections.forEach(section => {
              const sectionElement = template.content.cloneNode(true);

              // Set section data
              sectionElement.querySelector('.section-title').textContent = section.title;

              const sectionDate = new Date(section.generatedAt);
              sectionElement.querySelector('.section-date').textContent = sectionDate.toLocaleDateString();

              // Set section content (with markdown rendering)
              sectionElement.querySelector('.section-content').innerHTML = `
                <div class="section-text">
                  ${formatContent(section.content)}
                </div>
              `;

              // Add event listener for regenerate button
              sectionElement.querySelector('.regenerate-btn').addEventListener('click', function() {
                regenerateSection(reportId, section.type);
              });

              // Add section to report
              reportContent.appendChild(sectionElement);
            });
          }

          // Set up generate button
          const generateBtn = document.getElementById('generate-btn');
          generateBtn.addEventListener('click', function() {
            generateReport(reportId, report);
          });

          // Set up export button
          const exportBtn = document.getElementById('export-btn');
          exportBtn.addEventListener('click', function() {
            alert('Export functionality will be implemented in a future phase.');
          });

          // If report is currently generating, start polling for updates
          if (report.status === 'generating') {
            pollReportStatus(reportId);
          }

        } catch (error) {
          console.error('Error loading report:', error);
          document.getElementById('loading-container').style.display = 'none';
          document.getElementById('empty-state').style.display = 'block';
        }
      };

      // Poll for report status updates
      const pollReportStatus = async (reportId) => {
        try {
          const response = await fetch(`/api/reports/${reportId}/status`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            throw new Error('Failed to check report status');
          }

          const data = await response.json();

          // Update status badge
          const statusBadge = document.getElementById('report-status');
          let badgeClass = 'bg-secondary';
          let statusText = 'Draft';

          if (data.status === 'generating') {
            badgeClass = 'bg-warning text-dark';
            statusText = `Generating (${Math.round(data.progress)}%)`;
          } else if (data.status === 'completed') {
            badgeClass = 'bg-success';
            statusText = 'Completed';
          } else if (data.status === 'in_progress') {
            badgeClass = 'bg-info text-dark';
            statusText = 'In Progress';
          } else if (data.status === 'failed') {
            badgeClass = 'bg-danger';
            statusText = 'Failed';
          }

          statusBadge.className = `badge ${badgeClass}`;
          statusBadge.textContent = statusText;

          // If still generating, poll again in 3 seconds
          if (data.status === 'generating') {
            setTimeout(() => pollReportStatus(reportId), 3000);
          } else if (data.status === 'completed' || data.status === 'in_progress') {
            // Reload the report to show the new sections
            loadReport();
          }

        } catch (error) {
          console.error('Error polling report status:', error);
        }
      };

      // Generate full report
      const generateReport = async (reportId, reportData) => {
        try {
          // Update UI to show generating state
          const statusBadge = document.getElementById('report-status');
          statusBadge.className = 'badge bg-warning text-dark';
          statusBadge.textContent = 'Generating...';

          // Start generation
          const response = await fetch(`/api/reports/${reportId}/generate`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              companyData: {
                name: reportData.companyName,
                // Add any other company data available
              },
              templateType: reportData.templateType || 'mvp'
            })
          });

          if (!response.ok) {
            throw new Error('Failed to start report generation');
          }

          // Start polling for updates
          setTimeout(() => pollReportStatus(reportId), 3000);

        } catch (error) {
          console.error('Error generating report:', error);
          alert('Failed to generate report. Please try again.');

          // Restore previous status
          loadReport();
        }
      };

      // Regenerate a specific section
      const regenerateSection = async (reportId, sectionType) => {
        try {
          // Find section element and update UI
          const sectionElements = document.querySelectorAll('.report-section');
          let sectionElement = null;

          for (const element of sectionElements) {
            if (element.querySelector('.section-title').textContent === getSectionTitle(sectionType)) {
              sectionElement = element;
              break;
            }
          }

          if (sectionElement) {
            sectionElement.querySelector('.section-content').innerHTML = `
              <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Regenerating...</span>
                </div>
                <p class="mt-2">Regenerating section...</p>
              </div>
            `;
          }

          // Make API request to regenerate section
          const response = await fetch(`/api/reports/${reportId}/section`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sectionType: sectionType,
              companyData: {
                name: document.getElementById('report-title').textContent,
                // Add other company data if available
              }
            })
          });

          if (!response.ok) {
            throw new Error('Failed to regenerate section');
          }

          // Reload the report to show the updated section
          setTimeout(loadReport, 1000);

        } catch (error) {
          console.error('Error regenerating section:', error);
          alert('Failed to regenerate section. Please try again.');
          loadReport();
        }
      };

      // Helper function to get section title from section type
      const getSectionTitle = (sectionType) => {
        const titles = {
          executiveSummary: 'Executive Summary',
          companyOverview: 'Company Overview',
          marketAnalysis: 'Market Analysis',
          financialAnalysis: 'Financial Analysis',
          riskAssessment: 'Risk Assessment',
          investmentRecommendation: 'Investment Recommendation'
        };

        return titles[sectionType] || sectionType.charAt(0).toUpperCase() + sectionType.slice(1);
      };

      // Helper function to format content (basic markdown-like formatting)
      const formatContent = (content) => {
        if (!content) return '';

        // Simple formatting - paragraphs
        let formatted = content.replace(/\n\n/g, '</p><p>');
        formatted = '<p>' + formatted + '</p>';

        // Bold text
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Italic text
        formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

        // Headers
        formatted = formatted.replace(/^### (.*?)$/gm, '<h5>$1</h5>');
        formatted = formatted.replace(/^## (.*?)$/gm, '<h4>$1</h4>');
        formatted = formatted.replace(/^# (.*?)$/gm, '<h3>$1</h3>');

        return formatted;
      };

      // Load the report
      loadReport();
    });
  </script>
</body>
</html>